-- load the Bolt API
local bolt = require("bolt")

-- make sure this plugin is running on a Bolt version compatible with
-- the one it was written for (1.0)
bolt.checkversion(1, 0)

local particletexture = '\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x4a\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x0b\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x1b\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\xf5\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x1e\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00\xcd\xcd\xcd\x00'
local active = false
local alerted = false
local lastrockertunitytime = 0

local soundbrowser = bolt.createembeddedbrowser(
        50, 
        50, 
        75, 
        75, 
        "plugin://app/bell.html"
    )

local function playbell()
    soundbrowser:sendmessage("bell")
end

bolt.onrenderparticles(function (event)
    active = false
    for i = 1, event:vertexcount() do
        -- Getting the position in the texture atlas
        local meta = event:vertexmeta(i)
        local ax, ay, aw, ah = event:atlasxywh(meta)

        -- Is this a rockertunity particle?
        if aw == 128 and ah == 128 and event:texturecompare(ax, ay + 22, particletexture) then
            -- Only alert a single time per rockertunity
            active = true
            lastrockertunitytime = bolt.time()
            if not alerted then
                playbell()
                alerted = true
            end
        end
    end

    -- Reset active once the current rockertunity disappears - wait at least 1 second before resetting
    local now = bolt.time()
    if not active and alerted and now - lastrockertunitytime > 1000000 then
        alerted = false
    end
end)